## 카프카 클러스터 이중화

Kafka는 클러스터 내부의 장애에 대해서는 가용성과 Fault-Tolerance를 잘 보장해준다. 하지만 IDC 단위의 **클러스터 전체 장애**에 대해서는 별도로 대비를 해야 한다.

토스에서는 DR 처리를 위해서 IDC를 위치 상 떨어진 곳에 추가적으로 배치한다. 이때 IDC 추가 배치는 **Active-Standby**와 **Active-Active** 중 선택할 수 있다. Active-Standby를 구성할 경우, 장애가 발생한다는 보장이 없기 때문에 오랜 시간 사용되지 않을 가능성이 크고, 정작 장애가 발생했을때 구버전으로 인해 제대로 장애를 대비하지 못할 가능성이 있다. 따라서 Active-Active 구조를 선택할 수 있다. 이때 Active 간의 데이터가 **자동으로 동기화 되지는 않는다**. RDS의 Multi-AZ와는 느낌이 다르다.

### IDC 다중화 시 발생 가능한 문제점
클라이언트의 요청은 DR 처리된 IDC1과 IDC2에 부하 분산 될 수 있다. 이때 IDC 간에 쌓이는 데이터의 종류가 다르기 때문에 Consumer는 데이터의 반만 획득이 가능하다. 따라서 IDC 간의 동기화 작업이 필요하다.

이때 **Kafka Connect**와 **Offset Sync**를 사용할 수 있다. Kafka Connect를 사용해서 IDC간 클러스터의 이벤트를 미러링 할 수 있고, Offset Sync를 통해서 언제든지 컨슈머가 다른 클러스터에서도 데이터를 소비할 수 있도록 만들어야 한다.

컨슈머는 오직 하나의 IDC에서만 이벤트를 소비해야 한다. 그러지 않으면 이벤트 중복 소비를 하게 될 수 있다.


![](https://i.imgur.com/52GLoJo.png)

